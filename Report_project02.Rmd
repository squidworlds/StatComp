---
title: "Modelling Peak Electricity Demand in Great Britain"
author: "Group 50, Ella Park (s2311400), Saioa Galvin(s2516907),"
output:
  html_document:
    number_sections: no
  pdf_document:
    number_sections: no
header-includes:
  - \newcommand{\bm}[1]{\boldsymbol{#1}}
  - \newcommand{\mat}[1]{\begin{bmatrix}#1\end{bmatrix}}
---

```{r setup, include = FALSE}
# Set default code chunk options
knitr::opts_chunk$set(
  echo = TRUE,
  eval = TRUE
)

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(numDeriv))
suppressPackageStartupMessages(library(mvtnorm))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(latex2exp))
suppressPackageStartupMessages(library(lemon))
theme_set(theme_bw(base_size = 9))

demand <- read.csv("SCS_demand_modelling.csv")

set.seed(12345L)
```

```{r reading_code, code=readLines("code.R"), eval=TRUE, echo=FALSE}
source("code.R")
```

# Introduction- brief

This section provides a brief introduction to the task and the datasets used. The introduction is intended to be understood by NESO analysts with a scientific background but limited statistical expertise. You can assume that the reader of your report has read the executive summary. Briefly outline the overall approach taken in modeling future daily peak electricity demand, describe the main steps involved, and summarize the key conclusions drawn from the analysis.

# Introduction- part completed

Accurately forecasting future daily peak electricity demand is crucial for NESO's (National Electricity System Operator) planning and security of supply analysis. High demand events in winter pose the greatest risk of electricity shortfalls since cold weather increases energy consumption, so we are is particularly interested in modelling the upper tail of the demand distribution so NESO can better anticipate extreme scenarios and allocate reserves efficiently.

The primary dataset used, \texttt{SCS_demand_modelling.csv}, contains historical daily peak electricity demand data for Great Britain, focusing on winter months. The data spans from 1st November 1991 to 31st March 2014. Each row represents a single day, describing electricity demand and capturing key factors that influence this including weather conditions and renewable energy generation.

In this report, we develop and evaluate a linear regression model to estimate future peak demand using historical electricity demand data and relevant explanatory variables, focusing on the winter months where there is highest risk. We begin with a baseline model $M_0$ incorporating key predictors such as wind and solar generation, temperature, and temporal factors. We then explore model refinements by incorporating additional covariates, considering adjustments for long-term trends and alternative temperature variables. In order to compare and select our best model, we discuss how well our model fits historic data, prediction accuracy and how peak demand varies under different weather conditions. To compare prediction accuracy, we construct a cross-validation scheme that computes prediction scores across months and then weekdays versus weekends.

The final model is selected based on predictive performance and interpretability, providing NESO with a reliable tool for demand forecasting. We also discuss the limitations of the model and highlight areas for further improvement to enhance its accuracy and robustness.

THIS NEEDS IMPROVEMENTS- include key conclusions drawn

# Data description and exploratory analysis- Brief

Emphasis should be placed on the data features that are relevant for the subsequent modeling. Include visualizations that help illustrate key patterns or relationships. All plots must also be described in the write up. Think carefully about whether each plot needs to be included in your final draft. Your report should include figures and tables but they should be as focused and impactful as possible.

Clearly describe all preprocessing steps, including any transformations or new variables created. If the additional dataset (`SCS_hourly_temp.csv` ) is used, provide a concise explanation of its structure and relevance to the analysis.

# Data description and exploratory analysis- first draft

A thorough understanding of the dataset is essential for building an effective forecasting model. This section explores key features relevant to modelling, highlighting important patterns through visualizations to inform model development and summarizes the preprocessing steps undertaken.

We begin by examining the distribution of daily peak electricity demand and its relationship with key explanatory variables from our dataset, \texttt{SCS_demand_modelling.csv}. MOREEE

# Model fitting and cross-validation results

In this section you should detail your choice of model and describe the process used to refine and fit the model. You are encouraged to explore different models methods but you should not include a detailed narrative of all of these attempts. For instance, you can mention the approaches you tried tried and include a comparison but do not add in depth discussions of these models beyond why they were rejected. This section should mention the methods explored and why they were rejected, but most of your effort should go into describing the model you are using and your process for tuning and validating it.

Provide implementation details and include results from cross-validation or other model evaluation techniques, highlighting improvements and any trade-offs.

The model we are proposing is 

$$Gross Demand \sim wind + solar\_S + TE + daytype + monthindex + Year + Year^2 + Year^3 + \varepsilon,$$

where $daytype$ is a factor variable distinguishing between weekday and weekend. 

##* Other Models Considered

Ella, would you be able to give more detail here about which models you were looking at please? e.g. how you chose the models you did.

Backward selection?

To evaluate the models we considered, we first looked at the R-Squared and Adjusted R_Squared scores, as well as the AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion) [should we mention these?] and Root Mean Squared Error (RMSE). These metrics for each model are shown in the following table.

```{r comparing_models, warning = FALSE, echo=FALSE, out.width="50%", cache = FALSE}

# making daytype into a factor variable then taking out outliers
demand$daytype <- factor(
  ifelse(demand$wdayindex %in% 0:4, "Weekday", "Weekend"),
  levels = c("Weekday", "Weekend")
)
demand_no_outliers <- demand[demand$solar_S < 0.2,]


# models we are considering
m0 <- lm(demand_gross ~ wind + solar_S + temp + factor(wdayindex) + factor(monthindex), data = demand)
m0_year_cubed_te_squared <- lm(demand_gross ~ (wind + solar_S + TE + factor(wdayindex) + factor(monthindex) + poly(year, 3))^2, data = demand)
m0_daytype_outliers <- lm(demand_gross ~ wind + solar_S + temp + daytype + factor(monthindex), data = demand_no_outliers)
year_cubed_te_squared <- lm(demand_gross ~ (wind + solar_S + TE + I(daytype)^2 + monthindex + poly(year, 3))^2, data = demand_no_outliers)
best_no_outliers_sqr <- lm(demand_gross ~ (1 + wind + solar_S + TE + I(daytype)^2 + poly(monthindex, 3) + poly(year, 3))^2, data = demand_no_outliers)

# putting all these models into a vector for comparison
lms <- list(m0, m0_year_cubed_te_squared, m0_daytype_outliers, year_cubed_te_squared, best_no_outliers_sqr)
names <- c("m0", "Poly Year, TE, interactions", "m0, daytype factor, no outliers", "Poly Year, TE, interactions, no outliers", "final model")
datalist <- list(demand, demand, demand_no_outliers, demand_no_outliers, demand_no_outliers)

# creating the comparison table
comparison_df <- comparison(lms, names, datalist)
knit_print.comparison_df <- lemon_print

```

```{r comparison_table, warning = FALSE, echo=TRUE, out.width="50%", cache = FALSE}
head(comparison_df)
```

The table above shows that... I want to do analysis of R^2 here but I will wait until we have our best model.

##* Testing on Historical Data

We can check how well the model fits historical data by creating predictions for the historical data, then plotting.

```{r historical, warning = FALSE, echo=FALSE, out.width="50%", cache = FALSE}
# predicting on historical data using the function for all our linear models considered
# predictions <- list()
# 
# for (i in 1:length(lms)){
#   
#   lm <- lms[[i]]
#   data <- datalist[[i]]
#   prediction <- append(predictions, lm_predicting(lm, data))
#   
# }

# predicting for just m0 and our best model
m0_prediction <- lm_predicting(m0, demand)
m0_plot <- plotting(m0_prediction, demand)

best_prediction <- lm_predicting(best_no_outliers_sqr, demand_no_outliers)
best_plot <- plotting(best_prediction, demand_no_outliers)
```

```{r historical_plot, warning = FALSE, echo = FALSE, out.width="100%", cache = FALSE}
grid.arrange(m0_plot, best_plot, ncol = 2)
```

# Conslusion

Summarize here the key insights from your analysis, focusing on the final modelâ€™s predictive performance, reliability, and practical relevance for NESO. Discuss the importance of the selected covariates, as well as any observed limitations or assumptions that should be considered when applying the model in practice.

Emphasize how your model can support NESO's long-term planning goals. If the model underperforms in some respects, provide a clear and well-reasoned explanation. Keep in mind that a negative result, i.e. a model that does not work well predictively, that is well explained and justified in terms of why it failed will likely receive higher marks than a model with strong predictive performance but with poor or incorrect explanations and justifications. In other words, sound reasoning and transparency will be valued more than overclaiming results.

# Code Appendix

Include here all the code used in your analysis. Ensure that the code is well-commented so it is easy to follow and reuse.

```{r code=readLines("code.R"), eval=FALSE, echo=TRUE}
# Do not change this code chunk
```

